<!DOCTYPE html>
<html lang="pt" style="height: 100%">

<head>
  <meta charset="utf-8">
  <style>
    /* Estilos para o seletor de dados */
    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 5px;
      border-radius: 4px;
    }
  </style>
</head>

<body style="height: 100%; margin: 0">
  <div id="controls">
    <select id="dataTypeSelector">
      <option value="EXP" selected>Exportação</option>
      <option value="IMP">Importação</option>
      <option value="BAL">Balança Comercial (Exp - Imp)</option>
    </select>
  </div>

  <div id="container" style="height: 60%"></div>
  <div id="lineChart" style="height: 35%;"></div>

  <script type="text/javascript" src="https://echarts.apache.org/en/js/vendors/jquery@3.7.1/dist/jquery.min.js"></script>
  <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <script type="text/javascript">
    var mapDom = document.getElementById('container');
    var myChart = echarts.init(mapDom, null, { renderer: 'canvas', useDirtyRect: false });
    var lineDom = document.getElementById('lineChart');
    var lineChart = echarts.init(lineDom, null, { renderer: 'canvas', useDirtyRect: false });

    myChart.showLoading();

    $.when(
      $.getJSON('./assets/BR-exportacoes_importacoes_2025.json'),
      $.getJSON('./assets/world.json')
    ).done(function (tradeDataResponse, worldJsonResponse) {

      const tradeData = tradeDataResponse[0];
      const worldJson = worldJsonResponse[0];

      myChart.hideLoading();
      echarts.registerMap('WORLD', worldJson);

      const countryNameMap = {
        'Estados Unidos': 'United States', 'Países Baixos': 'Netherlands', 'Alemanha': 'Germany', 'Rússia': 'Russia',
        'Coreia do Sul': 'South Korea', 'Japão': 'Japan', 'Emirados Árabes Unidos': 'United Arab Emirates',
        'Arábia Saudita': 'Saudi Arabia', 'Reino Unido': 'United Kingdom', 'Espanha': 'Spain', 'Bélgica': 'Belgium',
        'Itália': 'Italy', 'Malásia': 'Malaysia', 'Canadá': 'Canada', 'França': 'France', 'Singapura': 'Singapore',
        'Colômbia': 'Colombia', 'Paraguai': 'Paraguay', 'Vietnã': 'Vietnam', 'Indonésia': 'Indonesia',
        'Turquia': 'Turkey', 'Uruguai': 'Uruguay', 'Hong Kong': 'Hong Kong', 'Austrália': 'Australia',
        'Tailândia': 'Thailand', 'Egito': 'Egypt', 'Suíça': 'Switzerland', 'Suécia': 'Sweden', 'Equador': 'Ecuador',
        'África do Sul': 'South Africa', 'Bolívia': 'Bolivia', 'Argélia': 'Algeria'
      };

      const titleMap = {
        'EXP': 'Volume de Exportações do Brasil (Ano 2025)',
        'IMP': 'Volume de Importações do Brasil (Ano 2025)',
        'BAL': 'Balança Comercial do Brasil (Ano 2025)'
      };

      function updateMap(dataType) {
        const year = '2025';
        const dataForYear = tradeData[dataType][year];

        const formattedData = dataForYear.map(item => ({
          name: countryNameMap[item.name] || item.name,
          value: item.us_value ?? null
        }));

        const values = formattedData
          .filter(item => item.value !== null)
          .map(item => item.value);

        const minValue = values.length > 0 ? Math.min(...values) : 0;
        const maxValue = values.length > 0 ? Math.max(...values) : 0;

        // --- Escala de cores ---
        let colorScale;
        if (dataType === 'BAL') {
          // divergente (déficit/superávit)
          colorScale = ['#d73027', '#f46d43', '#fee090', '#ffffbf', '#e0f3f8',
            '#abd9e9', '#74add1', '#4575b4', '#313695'].reverse();
        } else {
          // verde para export/import
          colorScale = ['#e0f3e0', '#a8ddb5', '#43a2ca', '#006d2c'];
        }

        let option = {
          title: {
            text: titleMap[dataType],
            subtext: 'Dados do Monitor do Comércio Exterior Brasileiro',
            left: 'center'
          },
          tooltip: {
            trigger: 'item',
            formatter: function (params) {
              if (typeof params.value !== 'number' || isNaN(params.value)) {
                return `<b>${params.name}</b><br/>(sem dados)`;
              }
              const rawValue = params.value;
              const valueInBillions = (rawValue / 1e9).toFixed(1).replace('.', ',');
              return `<b>${params.name}</b><br/><b>US$ ${valueInBillions} bi</b>`;
            }
          },
          visualMap: {
            left: 'right',
            min: minValue,
            max: maxValue,
            inRange: { color: colorScale },
            text: ['Volume negociado com o país (em bilhões de US$)'],
            calculable: true
          },
          toolbox: {
            show: true, left: 'left', top: 'top',
            feature: { dataView: { readOnly: false }, restore: {}, saveAsImage: {} }
          },
          series: [{
            name: 'Volume (USD)',
            type: 'map',
            roam: true,
            map: 'WORLD',
            data: formattedData,
            itemStyle: {
              emphasis: { areaColor: '#ffc107' }
            }
          }]
        };
        myChart.setOption(option, true);
      }

      // --- Gráfico de linhas ---
      const anos = Object.keys(tradeData.BAL);
      function getSoma(tipo) {
        return anos.map(ano => tradeData[tipo][ano]
          .reduce((acc, p) => acc + (p.us_value || 0), 0) / 1e9);
      }
      const balValores = getSoma('BAL');
      const impValores = getSoma('IMP');
      const expValores = getSoma('EXP');

      var lineOption = {
        title: { text: 'Totais por ano', left: 'left' },
        tooltip: { trigger: 'axis' },
        legend: { data: ['Exportações', 'Importações', 'Balança Comercial'], top: 30 },
        xAxis: { type: 'category', data: anos, name: 'Série Histórica' },
        yAxis: { type: 'value', name: 'Bilhões de US$' },
        series: [
          { data: expValores, type: 'line', name: 'Exportações', smooth: true },
          { data: impValores, type: 'line', name: 'Importações', smooth: true },
          { data: balValores, type: 'line', name: 'Balança Comercial', smooth: true }
        ]
      };
      lineChart.setOption(lineOption);

      // --- Corrigido: seletor ---
      $('#dataTypeSelector').on('change', function () {
        updateMap($(this).val());
      });

      updateMap('EXP');
    });

    window.addEventListener('resize', function () {
      myChart.resize();
      lineChart.resize();
    });
  </script>
</body>
</html>
